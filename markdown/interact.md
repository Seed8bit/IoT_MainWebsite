# 系统交互
在系统上电后，用户有三种方式可以与系统进行交互。第一种是通过以太网，第二种是通过SD卡，最后一种是通过Debug串口。
通过以太网和SD卡，用户可以将硬件操作文件通过远程PC发送给开发板或将硬件操作文件保存到SD卡的指定位置，硬件操作文件是JSON格式，里面记录了硬件该完成哪些动作（比如pin脚拉高电平，spi发送数据等等），后面的章节会着重解释硬件操作文件。
通过Debug串口和硬件交互，用户只能发送特定的指令，主要作用是配置参数和获取系统状态，比如配置IP地址，网关地址，子网掩码，或得到当前时间等等。后面的小节会着重说明。

## JSON请求
JSON是一种方便的存储或传输数据的格式。它基于面向对象的思想，非常易于理解。

参考百度文库：https://baike.baidu.com/item/JSON/2462549?fr=aladdin

## 通过以太网和系统交互

## 通过SD卡和系统交互
用户可将硬件操作文件，系统配置文件，或HTML文件存在SD卡的指定位置。当系统上电后，会自动读取系统配置文件，对外设进行配置，比如设置IP地址，网关地址等。当系统配置完成后，系统会进而读取硬件操作文件，硬件操作文件保存了对片上资源和外设的操作，比如每分钟读取ADC的值。

系统提供HTTP的支持，即用户可将前端文件保存到指定文件夹，利用外部浏览器进行访问。

下面我们对SD上的文件系统进行说明：

系统支持SD卡最高到4GB，目前只支持FAT32文件系统。如果您的SD卡是第一次尝试使用，请务必首先格式化SD卡，并且选择FAT32文件系统。

SD卡文件系统需要包括如下文件夹，
*public*, *user*, *system*, *firmware*.

* public: 该文件夹保存所有的静态网站相关的文件，包括HTML, CSS, JS等，当用户使用浏览器访问该系统时，系统会根据URL将静态文件返回给用户的浏览器，然后显示页面。
* user: 该文件夹包括用户定义的文件，系统上电后，会检测该文件夹中的`boot.json`文件，如果该文件存在，系统会处理该文件。`boot.json`文件中保存用户定义的硬件操作命令。
    * 后续章节有详细的硬件操作指令的说明。
    * 示例：请将该JSON文件保存到user文件夹，并命名为`boot.json`，当系统上电后，引脚10会设置为高电平:

```
{
  "event":"now",
  "actions": [["gpio", 10, "output", "high"]],
}
```

* system: 该文件夹包括配置系统所需的文件，系统上电后，会检测该文件夹中的`config.json`文件，如果该文件存在，系统会进行处理。支持的系统配置包括：IP地址，子网掩码，网关地址，MDNS名称，电压设置。
    * IP地址，子网掩码，网关地址:
        * 系统默认使用DHCP从路由器获得网络相关的参数(IP, 子网掩码和网关地址)，但当用户定义了这些参数时，系统则不会使用DHCP，而是使用用户指定的网络参数进行配置。IP地址对应的JSON 键为`ip`，子网掩码对应的JSON 键为`netmask`，网关地址对应的JSON 键为`gateway`。比如如下例子，用户配置了IP地址为192.168.1.101，子网掩码为255.255.255.0，网关地址为192.168.1.1。

```
{
  "ip": "192.168.1.101",
  "netmask": "255.255.255.0",
  "gateway": "192.168.1.1",
}
```

* MDNS名称：
    * 系统支持MDNS，即用户可以通过MDNS名称访问HTTP服务器，而不是IP地址。当用户定义了MDNS名称时，MDNS功能启动。MDNS对应的JSON键为`mdns`，以下例子，用户配置了IP地址为192.168.1.101，子网掩码为255.255.255.0，网关地址为192.168.1.1，且MDNS名称为"rectcream"。

```
{
  "mdns": "rectcream",
  "ip": "192.168.1.101",
  "netmask": "255.255.255.0",
  "gateway": "192.168.1.1",
}
```

* 电压设置：
    * 用户可以选择在Vbus引脚上输出5V/9V/15V/20V之一。用户所使用的外设最高的功率不能高于100W。电压设置对应的键值为`voltage`，如下的示例将MDNS名称为"rectcream"并将Vbus引脚设置为15V。

```
{
  "mdns": "rectcream",
  "voltage": "15v",
}
```

## 通过Debug串口和系统交互
当用户通过Debug串口与系统进行交互时，需要额外的USB-串口转接线，用户需要连接USB一端到PC，另一端串口端，连接到Debug Port，请参考第一章的“引脚分配图”。当线连接好后，PC端需要下载USB-串口的驱动，待驱动连接好后，系统上电，打开任何一款串口通信软件（比如teraterm）。选择对应的波特率，然后即可与系统通过串口进行交互了

串口端的初始波特率为9600。系统上电后，会将固件的版本号打印到串口上，用户可以以此来确定是否已将串口设置好。

为了和系统进行交互，用户需要发送对应的串口指令。目前支持的串口指令如下：

* 读取最近的错误码

* 输出电压配置:
    * `voltage write [5v/9v/15v/20v]`
        * 将电压参数写入非易失性存储器中，系统将会在重新上电时，使用该参数配置电压。
        * 参数：需要在5v / 9v / 15v / 20v选择其一
        * 返回：1 或 0，1代表成功，0代表失败

    * `voltage read`
        * 读取保存在非易失性存储器中的电压参数
        * 参数：无
        * 返回：5代表5v，9代表9v，15代表15v，20代表20v，0代表未进行设置。

* 时间配置:
    * `time write [year] [month] [date] [hour] [minute] [second]`
        * 将时间参数写入时间控制模块中

    * `time read`
        * 读取在时间控制模块中的时间信息。

* IP地址设置

* 子网掩码设置

* 网关设置

* MDNS名称设置

* 固件版本

* 恢复系统初始设置
